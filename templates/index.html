from flask import Flask, render_template, request, redirect, url_for, session, jsonify, flash
from werkzeug.utils import secure_filename
import os

app = Flask(__name__)  # Fixed: __name__ instead of name
app.secret_key = 'admin123'
UPLOAD_FOLDER = 'static/uploads'
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER

# In-memory data
users = {
    "user1": {"earnings": 0.50},
    "user2": {"earnings": 1.75}
}
withdrawals = []
videos = []
youtuber_campaigns = []

# Admin settings
def get_settings():
    return {
        "reward_per_session": 0.001  # USD earned per 30s watch
    }

settings = get_settings()

# -------------------- PUBLIC ROUTES --------------------

@app.route('/')
def index():
    video_list = []
    for i, video in enumerate(videos):
        video_list.append({**video, "id": i})
    return render_template('index.html', videos=video_list)

@app.route('/earnings')
def get_earnings():
    return jsonify({"earnings": 1.25})

@app.route('/watch/<int:video_id>')  # Fixed: <int:video_id> instead of /int:video_id
def watch(video_id):
    if 0 <= video_id < len(videos):
        return render_template('watch.html', 
                             video=videos[video_id], 
                             video_id=video_id, 
                             reward=settings["reward_per_session"])
    return "Video not found", 404

# -------------------- ADMIN AUTH --------------------

@app.route('/admin-login', methods=['GET', 'POST'])
def admin_login():
    if request.method == 'POST':
        username = request.form['username']
        password = request.form['password']
        if username == 'admin' and password == 'admin':
            session['admin'] = True
            return redirect('/admin-dashboard')
        else:
            flash("Invalid credentials.")
    return render_template('login.html')

@app.route('/logout')
def logout():
    session.clear()
    return redirect('/')

# -------------------- ADMIN DASHBOARD --------------------

@app.route('/admin-dashboard')
def admin_dashboard():
    if not session.get('admin'):
        return redirect('/admin-login')
    return render_template('dashboard.html', 
                         users=users, 
                         withdrawals=withdrawals, 
                         videos=videos, 
                         visitors=123, 
                         youtuber_campaigns=youtuber_campaigns, 
                         settings=settings)

@app.route('/update-settings', methods=['POST'])
def update_settings():
    if not session.get('admin'):
        return redirect('/admin-login')
    try:
        settings["reward_per_session"] = float(request.form['reward_per_session'])
        flash("Settings updated.")
    except:
        flash("Invalid input. Please enter a number.")
    return redirect('/admin-dashboard')

@app.route('/upload', methods=['POST'])
def upload():
    if not session.get('admin'):
        return redirect('/admin-login')
    if 'video' in request.files:
        video = request.files['video']
        title = request.form['title']
        thumbnail = request.form.get('thumbnail', '')
        filename = secure_filename(video.filename)
        path = os.path.join(app.config['UPLOAD_FOLDER'], filename)
        video.save(path)
        videos.append({"title": title, "filename": filename, "thumbnail": thumbnail})
    return redirect('/admin-dashboard')

@app.route('/delete/<int:vid_id>', methods=['POST'])  # Fixed: <int:vid_id> instead of /int:vid_id
def delete_video(vid_id):
    if not session.get('admin'):
        return redirect('/admin-login')
    if 0 <= vid_id < len(videos):
        del videos[vid_id]
    return redirect('/admin-dashboard')

@app.route('/withdraw')
def withdraw_page():
    if not session.get('admin'):
        return redirect('/admin-login')
    return render_template('withdraw.html', withdrawals=withdrawals)

@app.route('/withdraw/<int:req_id>/approve', methods=['POST'])  # Fixed: <int:req_id> instead of /int:req_id
def approve_withdraw(req_id):
    if not session.get('admin'):
        return redirect('/admin-login')
    if 0 <= req_id < len(withdrawals):
        withdrawals[req_id]['status'] = 'approved'
    return redirect('/admin-dashboard')

@app.route('/withdraw/<int:req_id>/reject', methods=['POST'])  # Fixed: <int:req_id> instead of /int:req_id
def reject_withdraw(req_id):
    if not session.get('admin'):
        return redirect('/admin-login')
    if 0 <= req_id < len(withdrawals):
        withdrawals[req_id]['status'] = 'rejected'
    return redirect('/admin-dashboard')

# -------------------- YOUTUBER SUBMISSION --------------------

@app.route('/youtuber-upload', methods=['GET', 'POST'])
def youtuber_upload():
    if request.method == 'POST':
        title = request.form['title']
        youtube_link = request.form['youtube_link']
        submitted_by = request.form['submitted_by']
        youtuber_campaigns.append({
            'title': title,
            'youtube_link': youtube_link,
            'submitted_by': submitted_by,
            'status': 'pending'
        })
        return "Submitted"
    return '''
    <form method="POST">
        <input name='title' placeholder='Video Title'><br>
        <input name='youtube_link' placeholder='YouTube URL'><br>
        <input name='submitted_by' placeholder='Your Email'><br>
        <button type='submit'>Submit</button>
    </form>
    '''

@app.route('/approve-campaign/<int:index>', methods=['POST'])  # Fixed: <int:index> instead of /int:index
def approve_campaign(index):
    if not session.get('admin'):
        return redirect('/admin-login')
    if 0 <= index < len(youtuber_campaigns):
        youtuber_campaigns[index]['status'] = 'approved'
    return redirect('/admin-dashboard')

@app.route('/reject-campaign/<int:index>', methods=['POST'])  # Fixed: <int:index> instead of /int:index
def reject_campaign(index):
    if not session.get('admin'):
        return redirect('/admin-login')
    if 0 <= index < len(youtuber_campaigns):
        youtuber_campaigns[index]['status'] = 'rejected'
    return redirect('/admin-dashboard')

# -------------------- MAIN --------------------

if __name__ == '__main__':  # Fixed: __name__ and __main__ instead of name and main
    os.makedirs(UPLOAD_FOLDER, exist_ok=True)
    app.run(debug=True, port=5000)
